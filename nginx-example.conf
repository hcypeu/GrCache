user www www;
worker_processes 4;
worker_cpu_affinity auto;

error_log /data/wwwlogs/error_nginx.log crit;
#pid /var/run/nginx.pid;
pid /usr/local/nginx/logs/nginx.pid;
worker_rlimit_nofile 51200;

events {
  use epoll;
  worker_connections 51200;
  multi_accept on;
}

http {
  include mime.types;
  default_type application/octet-stream;
  log_format main '"$remote_addr" "$remote_user" [$time_local] "$http_host" "$request_method" "$uri" "$query_string" "$status" "$body_bytes_sent" "$http_referer" "$upstream_status" "$request_time" "$upstream_response_time" "$http_user_agent" "$http_x_forwarded_for" "$upstream_cache_status"';
  #log_format log_json '{ "timestamp": "$time_local", "remote_addr": "$remote_addr", "referer": "$http_referer", "request": "$request", "server_name": "$server_name", "method": "$request_method", "uri": "$uri", "status": $status, "bytes": $body_bytes_sent, "agent": "$http_user_agent", "x_forwarded": "$http_x_forwarded_for", "upstream_addr": "$upstream_addr", "upstream_host": "$upstream_http_host", "upstream_resp_time": "$upstream_response_time", "request_time": "$request_time", "cache_status": "$upstream_cache_status", "hostname": "$hostname", "server_addr": "$server_addr", "node_id": "7c61381341772c9dcceb75435387aece" }';
  #access_log syslog:server=log.example.com:514,facility=user,tag=nginx,severity=info log_json;
  proxy_cache_path /data/cache levels=1:2 keys_zone=cache_one:100m inactive=365d max_size=1g;
  proxy_temp_path temp;
  proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
  server_names_hash_bucket_size 128;
  client_header_buffer_size 32k;
  large_client_header_buffers 4 32k;
  client_max_body_size 1024m;
  client_body_buffer_size 10m;
  sendfile on;
  tcp_nopush on;
  keepalive_timeout 120;
  server_tokens off;
  tcp_nodelay on;

  proxy_connect_timeout 8s;
  proxy_send_timeout 120s;
  proxy_read_timeout 120s;
  proxy_buffer_size 16k;
  proxy_buffers 4 16k;
  proxy_busy_buffers_size 48k;
  proxy_temp_file_write_size 64k;
  proxy_max_temp_file_size 128m;
  ##Limit the number of TCP links
  limit_conn_zone $binary_remote_addr zone=addr:10m;
  limit_conn addr 300;
  charset UTF-8;

  #Gzip Compression
  gzip on;
  gzip_buffers 16 8k;
  gzip_comp_level 3;
  gzip_http_version 1.1;
  gzip_min_length 1k;
  gzip_proxied any;
  gzip_vary on;
  gzip_types
    text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml
    text/javascript application/javascript application/x-javascript
    text/x-json application/json application/x-web-app-manifest+json
    text/css text/plain text/x-component
    font/opentype application/x-font-ttf application/vnd.ms-fontobject
    image/x-icon;
  gzip_disable "MSIE [1-6]\.(?!.*SV1)";

  ##If you have a lot of static files to serve through Nginx then caching of the files' metadata (not the actual files' contents) can save some latency.
  open_file_cache max=1000 inactive=20s;
  open_file_cache_valid 30s;
  open_file_cache_min_uses 2;
  open_file_cache_errors on;
  proxy_cache_key '"$host$request_uri$cookie_user"';
  proxy_cache_lock on;
  proxy_cache_lock_timeout 2s;
  proxy_cache_min_uses 1;
  proxy_cache_use_stale error timeout invalid_header updating http_500 http_503 http_404;
  proxy_ignore_client_abort off;
  proxy_intercept_errors on;
  proxy_hide_header Server;
  index index.htm index.html;
  error_page 500 http://$server_addr/e500.html;
  error_page 502 http://$server_addr/e502.html;
  error_page 503 http://$server_addr/e503.html;
  error_page 504 http://$server_addr/e504.html;

######################## default ############################
  server {
    listen 80 default_server;
    listen 443 default_server;
    ssl_certificate ssl/default.crt;
    ssl_certificate_key ssl/default.key;
    server_name _;
    access_log /data/wwwlogs/access_nginx.log combined;
    location / {
        root html;
    }
    location /nginx_health {
      stub_status on;
      access_log off;
      allow 127.0.0.1;
      deny all;
    }
  }
########################## vhost #############################
  include vhost/*.conf;
}
